@using E25ProjetEtendu.Extensions
@using E25ProjetEtendu.Enums
@model E25ProjetEtendu.Models.Order

@{
    ViewData["Title"] = "Current Order Status";
    var subtotal = Model.OrderItems.Sum(i => i.Quantity * i.UnitPrice);
    var tps = subtotal * 0.05m;
    var tvq = subtotal * 0.09975m;
    var total = subtotal + tps + tvq;
}

<h1 class="text-center my-4">Statut de votre commande</h1>

<div class="card mb-4 shadow-sm">
    <div class="card-body row">
        <div class="col-md-6">
            <p><strong>ID de la commande :</strong> @Model.OrderId</p>
            <p><strong>Date :</strong> @Model.OrderDate.ToString("f")</p>
            <p><strong>Prix total :</strong> @Model.TotalPrice.ToString("C")</p>
            <p><strong>Lieu de livraison :</strong> @(string.IsNullOrEmpty(Model.Location) ? "Non spécifiée" : Model.Location)</p>
        </div>
        <div class="col-md-6 d-flex align-items-center justify-content-md-end">
            <p class="mb-0 me-2"><strong>Statut :</strong></p>
            <div class="order-status-badge">
                <span class="badge status-@Model.Status.ToString().ToLower()">
                    @Model.Status.GetDisplayName()
                </span>
            </div>

        </div>
        @if (Model.Deliverer != null)
        {
            <p><strong>Livreur :</strong> @Model.Deliverer.FirstName</p>
        }
        else if(Model.Status == OrderStatus.Pending)
        {
            <div class="text-end">
                <button type="button" class="btn btn-danger mt-3" data-bs-toggle="modal" data-bs-target="#cancelBuyerModal">
                    Annuler la commande
                </button>
            </div>
        }

       
    </div>
</div>


<h4 class="mt-5">Articles commandés</h4>
<table class="table table-bordered table-hover">
    <thead class="table-light">
        <tr>
            <th>Produit</th>
            <th class="text-center">Quantité</th>
            <th class="text-end">Prix unitaire</th>
            <th class="text-end">Total</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model.OrderItems)
        {
            <tr>
                <td>@item.Product.Nom</td>
                <td class="text-center">@item.Quantity</td>
                <td class="text-end">@item.UnitPrice.ToString("C")</td>
                <td class="text-end">@((item.Quantity * item.UnitPrice).ToString("C"))</td>

            </tr>
        }
    </tbody>
</table>

<div class="card mt-4">
    <div class="card-body text-end">
        <p><strong>Sous-total :</strong> @subtotal.ToString("C")</p>
        <p class="text-muted mb-1"><strong>TPS (5%) :</strong> @tps.ToString("C")</p>
        <p class="text-muted mb-3"><strong>TVQ (9.975%) :</strong> @tvq.ToString("C")</p>
        <h4 class="fw-bold"><strong>Total :</strong> @total.ToString("C")</h4>
    </div>
</div>

<!-- Modal de confirmation d'annulation par l'acheteur -->
<div class="modal fade" id="cancelBuyerModal" tabindex="-1" aria-labelledby="cancelBuyerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow">
            <form method="post" asp-controller="Order" asp-action="CancelAsBuyer">
                <input type="hidden" name="orderId" value="@Model.OrderId" />
                <input type="hidden" name="returnUrl" value="@Url.Action("CurrentOrderStatus", "Order", new { id = Model.OrderId })" />

                <div class="modal-header">
                    <h5 class="modal-title" id="cancelBuyerModalLabel">Confirmation d'annulation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>

                <div class="modal-body">
                    Êtes-vous certain(e) de vouloir annuler la commande <strong>#@Model.OrderId</strong> ?
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Oui, annuler</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Non</button>
                </div>
            </form>
        </div>
    </div>
</div>



<!--Vide le panier si redirigé depuis Success()-->
@if (TempData["ClearCart"]?.ToString() == "true")
{
    <script>
        localStorage.removeItem('panier_' + document.body.dataset.userid);
        localStorage.removeItem('deliveryLocation');
    </script>
}
@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const orderId = @Model.OrderId;
        const userId = "@User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value";

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/orderStatusHub")
            .build();

        connection.on("ReceiveOrderStatusUpdate", function (updatedOrderId, newStatus) {
            // Vérifie que c'est bien cette commande
            if (updatedOrderId === orderId) {
                console.log("📦 Mise à jour du statut reçue : " + newStatus);

                // Si déjà Delivered ou Cancelled, on évite les reloads inutiles
                const currentStatus = "@Model.Status.ToString()";
                if (currentStatus !== newStatus) {
                    console.log("🔁 Statut différent, rechargement de la page...");
                    location.reload();
                } else {
                    console.log("✅ Statut inchangé, pas de reload.");
                }
            }
        });

        connection.start()
            .then(() => {
                console.log("✅ Connexion SignalR établie (CurrentOrderStatus).");
                if (userId) {
                    connection.invoke("JoinGroup", userId)
                        .then(() => console.log("📡 Rejoint le groupe de l'utilisateur : " + userId))
                        .catch(err => console.error("❌ Erreur d'abonnement :", err));
                }
            })
            .catch(err => console.error("❌ Échec de la connexion SignalR :", err));
    </script>
}


